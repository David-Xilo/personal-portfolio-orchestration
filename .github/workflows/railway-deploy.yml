name: Deploy Railway Infrastructure

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

jobs:
  check-docker-images:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Verify Docker images exist
        run: |
          echo "ğŸ” Verifying Docker images exist on Docker Hub..."
          
          BACKEND_IMAGE="xilo/safehouse-backend-main:latest"
          FRONTEND_IMAGE="xilo/safehouse-frontend-main:latest"
          MIGRATION_IMAGE="xilo/safehouse-migrations:latest"
          
          # Check backend image
          if ! docker manifest inspect $BACKEND_IMAGE > /dev/null 2>&1; then
            echo "âŒ Backend image not found: $BACKEND_IMAGE"
            exit 1
          fi
          
          # Check frontend image  
          if ! docker manifest inspect $FRONTEND_IMAGE > /dev/null 2>&1; then
            echo "âŒ Frontend image not found: $FRONTEND_IMAGE"
            exit 1
          fi
          
          # Check migration image
          if ! docker manifest inspect $MIGRATION_IMAGE > /dev/null 2>&1; then
            echo "âŒ Migration image not found: $MIGRATION_IMAGE"
            exit 1
          fi
          
          echo "âœ… All Docker images verified successfully"

  run-migrations:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    needs: check-docker-images
    steps:
      - name: Deploy migrations via API
        run: |
          curl -X POST "https://backboard.railway.com/graphql/v2" \
            -H "Authorization: Bearer ${{ secrets.RAILWAY_TOKEN }}" \
            -H "Content-Type: application/json" \
            -d '{
              "query": "mutation { 
                serviceInstanceDeploy(
                  serviceId: \"${{ secrets.MIGRATION_SERVICE_ID }}\",
                  input: { 
                    dockerImage: \"xilo/safehouse-migrations:latest\"
                  }
                ) { 
                  id 
                  status 
                } 
              }"
            }'

  deploy-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: run-migrations
    container: ghcr.io/railwayapp/cli:latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Deploy backend
        run: |
          echo "ğŸš€ Deploying backend image: xilo/safehouse-backend-main:latest"
          railway redeploy --service safehouse-backend-main
          echo "âœ… Backend deployment initiated."

  deploy-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: deploy-backend
    container: ghcr.io/railwayapp/cli:latest
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Deploy frontend
        run: |
          echo "ğŸš€ Deploying frontend image: xilo/safehouse-frontend-main:latest"
          railway redeploy --service safehouse-frontend-main
          echo "âœ… Frontend deployment initiated."

  post-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-frontend
    container: ghcr.io/railwayapp/cli:latest
    if: always()
    env:
      RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}
    steps:
      - name: Show status and usage
        run: |
          echo "ğŸ“Š Final deployment status:"
          railway status
          echo "ğŸ’° Current usage:"
          railway usage
          echo "ğŸ‰ Done! Check it here:"
          echo "https://railway.app/project/${{ secrets.RAILWAY_PROJECT_ID }}"
