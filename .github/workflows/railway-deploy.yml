name: Deploy Railway Infrastructure

on:
  workflow_dispatch:
    inputs:
      backend_version:
        description: 'Backend Docker image version (e.g., v1.2.3)'
        default: 'latest'
        required: true
        type: string
      frontend_version:
        description: 'Frontend Docker image version (e.g., v2.1.0)'
        default: 'latest'
        required: true
        type: string
      migration_version:
        description: 'Migration Docker image version (e.g., v1.0.5)'
        default: 'latest'
        required: true
        type: string
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production

env:
  RAILWAY_PROJECT_ID: 03936bb2-d116-4765-beeb-c29074266234
  DOCKER_REGISTRY: xilo
  RAILWAY_TOKEN: ${{ secrets.RAILWAY_TOKEN }}

jobs:
  check-docker-images:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Verify Docker images exist
        run: |
          echo "ğŸ” Verifying Docker images exist on Docker Hub..."
          
          BACKEND_IMAGE="${DOCKER_REGISTRY}/safehouse-backend-main:${{ inputs.backend_version }}"
          FRONTEND_IMAGE="${DOCKER_REGISTRY}/safehouse-frontend-main:${{ inputs.frontend_version }}"
          MIGRATION_IMAGE="${DOCKER_REGISTRY}/safehouse-migrations:${{ inputs.migration_version }}"
          
          # Check backend image
          if ! docker manifest inspect $BACKEND_IMAGE > /dev/null 2>&1; then
            echo "âŒ Backend image not found: $BACKEND_IMAGE"
            exit 1
          fi
          
          # Check frontend image  
          if ! docker manifest inspect $FRONTEND_IMAGE > /dev/null 2>&1; then
            echo "âŒ Frontend image not found: $FRONTEND_IMAGE"
            exit 1
          fi
          
          # Check migration image
          if ! docker manifest inspect $MIGRATION_IMAGE > /dev/null 2>&1; then
            echo "âŒ Migration image not found: $MIGRATION_IMAGE"
            exit 1
          fi
          
          echo "âœ… All Docker images verified successfully"

  run-migrations:
    runs-on: ubuntu-latest
    timeout-minutes: 15
    container: ghcr.io/railwayapp/cli:latest
    needs: check-docker-images
    steps:
      - name: Run database migrations
        run: |
          TIMESTAMP=$(date +%s)
          SERVICE_NAME="migration-${TIMESTAMP}"
          echo "ğŸš€ Deploying migration service: $SERVICE_NAME"
          railway add \
            --service "$SERVICE_NAME" \
            --image "${{ env.DOCKER_REGISTRY }}/safehouse-migrations:${{ inputs.migration_version }}" \
            --variables "DATABASE_URL=${DATABASE_URL}" \
            --variables "MIGRATION_TIMEOUT=300" \
            --variables "MIGRATION_VERBOSE=true"
          echo "ğŸš€ Running up
          railway up --service "$SERVICE_NAME" --ci
          sleep 10
          railway logs --service "$SERVICE_NAME" --wait
          
          echo "ğŸ§¹ Cleaning up migration service..."
          railway service delete "$SERVICE_NAME" --yes || true
          echo "âœ… Migrations completed."

  deploy-backend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: run-migrations
    container: ghcr.io/railwayapp/cli:latest
    steps:
      - name: Update or create service image
        run: |
          echo "ğŸš€ Deploying backend image: ${{ env.DOCKER_REGISTRY }}/safehouse-backend-main:${{ inputs.backend_version }}"
          railway add \
            --service safehouse-backend-main \
            --image "${{ env.DOCKER_REGISTRY }}/safehouse-backend-main:${{ inputs.backend_version }}" \
            --variables "PORT=8080" \
            --variables "DATABASE_URL=${DATABASE_URL}"

      - name: Deploy new Docker image
        run: |
          railway up --service safehouse-backend-main

  deploy-frontend:
    runs-on: ubuntu-latest
    timeout-minutes: 10
    needs: deploy-backend
    container: ghcr.io/railwayapp/cli:latest
    steps:
      - name: Deploy frontend
        run: |
          echo "ğŸš€ Deploying frontend image: ${{ env.DOCKER_REGISTRY }}/safehouse-frontend-main:${{ inputs.frontend_version }}"
          railway add \
              --service safehouse-frontend-main \
              --image "${{ env.DOCKER_REGISTRY }}/safehouse-frontend-main:${{ inputs.frontend_version }}"
          railway up --service safehouse-frontend-main
          echo "âœ… Frontend deployment initiated."

  post-deployment:
    runs-on: ubuntu-latest
    timeout-minutes: 5
    needs: deploy-frontend
    container: ghcr.io/railwayapp/cli:latest
    if: always()
    steps:
      - name: Show status and usage
        run: |
          echo "ğŸ“Š Final deployment status:"
          railway status
          echo "ğŸ’° Current usage:"
          railway usage
          echo "ğŸ‰ Done! Check it here:"
          echo "https://railway.app/project/${{ env.RAILWAY_PROJECT_ID }}"
